{% extends "base.html" %}

{% block content %}
<main>
  <h1 class="font-bold text-3xl mb-12">Inventory</h1>

  <p class="border border-red bg-red-950 text- w-[100%] py-6 flex items-center justify-center font-bold rounded-xl alert hidden"></p>

  <ul class="items">
    {% for item in inventory %}
    <li data-index="{{ loop.index }}" data-name="{{ item[0] }}" data-quantity="{{ item[1] }}" data-unit="{{ item[2] }}" class="item-wrapper">
      <p class="transition-colors duration-500">{{ item[0] }}</p>
      <div class="status"><span id="quantity{{ loop.index }}">{{ item[1] }}</span> {{item[2]}}</div>
      <button class="btn interactable show-dialog">Update</button>
    </li>
    {% endfor %}
  </ul>

  <!-- Button to Add New Item -->
  <!-- <button id="addItemBtn" class="btn interactable">Add New Item</button> -->
  <button class="flex items-center gap-4 border px-2 py-4 hover:bg-slate-900 transition rounded-lg mt-8 interactable" id="addItemBtn">
    <ion-icon name="add-circle-outline" size="large"></ion-icon>
    <h3 class="text-xl font-semibold">Add Item</h3>
  </button>

  <!-- Single Reusable Dialog -->
  <dialog id="updateDialog">
    <h1>Update</h1>
    <form id="updateForm">
      <p id="itemName" class="text-[#dadada]"></p>
      <div class="flex">
        <input type="text" placeholder="New Quantity" id="inputQuantity" class="text-[#dadada] inv-input flex-1">
        <select id="inputUnit" class="text-[#dadada] inv-input flex-1 ml-2">
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="l">l</option>
          <option value="ml">ml</option>
          <option value="pieces">pieces</option>
        </select>
      </div>
      <div>
        <button value="cancel" formmethod="dialog" class="btn-2 interactable">Cancel</button>
        <button id="confirmBtn" value="default" class="btn-2 interactable">Confirm</button>
        <button type="button" id="deleteBtn" class="btn-2 interactable bg-red-500 ml-2">Delete</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog for Adding New Item -->
  <dialog id="addItemDialog">
    <h1>Add New Item</h1>
    <form id="addItemForm">
      <input type="text" placeholder="Item Name" id="newItemName" class="text-[#dadada] inv-input" required>
      <input type="text" placeholder="Quantity" id="newItemQuantity" class="text-[#dadada] inv-input" required>
      <select id="newItemUnit" class="text-[#dadada] inv-input" required>
        <option value="kg">kg</option>
        <option value="g">g</option>
        <option value="l">l</option>
        <option value="ml">ml</option>
        <option value="pieces">pieces</option>
      </select>
      <div>
        <button type="button" id="cancelAddItemBtn" class="btn-2 interactable">Cancel</button>
        <button id="addBtn" value="default" class="btn-2 interactable">Add</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog for Delete Confirmation -->
  <dialog id="deleteDialog" class="">
    <div class="flex flex-col text-white items-center justify-center gap-6">
      <h1 class="m-0 p-0">Confirm Delete</h1>
      <p>Are you sure you want to delete this item?</p>
      <div class="flex justify-between w-full">
        <button value="cancel" id="nodeletebtn" class="btn-2 interactable">No</button>
        <button id="confirmDeleteBtn" class="btn-2 interactable bg-red-500">Yes</button>
      </div>
    </div>
  </dialog>
</main>

<script>
  const updateDialog = document.getElementById('updateDialog');
  const addItemDialog = document.getElementById('addItemDialog');
  const deleteDialog = document.getElementById('deleteDialog');
  const inputQuantity = document.getElementById('inputQuantity');
  const inputUnit = document.getElementById('inputUnit');
  const confirmBtn = document.getElementById('confirmBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const addItemBtn = document.getElementById('addItemBtn');
  const cancelAddItemBtn = document.getElementById('cancelAddItemBtn');
  const itemName = document.getElementById('itemName');
  const updateForm = document.getElementById('updateForm');
  const addItemForm = document.getElementById('addItemForm');
  const nodeletebtn = document.getElementById('nodeletebtn');
  let currentItemIndex = null;

  const threshold = 5;

  document.addEventListener('DOMContentLoaded', () => {
    const inventoryData = {{ inventory | tojson }};
    checkQuantity(inventoryData);

    attachEventListeners();
    updateForm.addEventListener('submit', (event) => {
      event.preventDefault();
      confirmUpdate();
    });


    addItemBtn.addEventListener('click', () => {
      addItemDialog.showModal();
    });

    nodeletebtn.addEventListener('click', () => {
      deleteDialog.close()
    });

    cancelAddItemBtn.addEventListener('click', () => {
      addItemDialog.close();
    });

    addItemForm.addEventListener('submit', (event) => {
      event.preventDefault();
      addNewItem();
    });
  });

  const blinkIntervals = {};

  function blink(item) {
    const intervalId = setInterval(() => {
      item.classList.toggle('blink');
    }, 750);
    return intervalId;
  }

  function stopBlink(item) {
    const itemName = item.textContent;
    if (blinkIntervals[itemName]) {
      clearInterval(blinkIntervals[itemName]);
      delete blinkIntervals[itemName];
      item.classList.remove('blink');
    }
  }

  function checkQuantity(param) {
    let jsinventory = param;
    let isAlert = false;
    const alert = document.querySelector('.alert');
    const lowItems = [];

    for (const i of jsinventory) {
      const itemLabel = document.querySelector(`[data-name="${i[0]}"]`).querySelector('p');

      if (parseInt(i[1]) < threshold) {
        lowItems.push(`${i[1]} ${i[2]} of ${i[0]}`);
        isAlert = true;

        if (!blinkIntervals[i[0]]) {
          blinkIntervals[i[0]] = blink(itemLabel);
        }
      } else {
        stopBlink(itemLabel);
      }
    };

    if (isAlert) {
      alert.classList.remove('hidden');
      alert.textContent = `Restock immediately: ${lowItems.join(', ')}`;
    } else {
      alert.classList.add('hidden');
    }
  }

  function confirmUpdate() {
    const newQuantity = inputQuantity.value;
    const newUnit = inputUnit.value;
    const name = itemName.textContent;
    updateDialog.close(newQuantity);

    if (currentItemIndex) {
      document.getElementById(`quantity${currentItemIndex}`).textContent = newQuantity;

      const button = document.querySelector(`.item-wrapper[data-index="${currentItemIndex}"]`);
      if (button) {
        button.setAttribute('data-quantity', newQuantity);
        button.setAttribute('data-unit', newUnit);
        button.querySelector('.status').innerHTML = `<span id="quantity${currentItemIndex}">${newQuantity}</span> ${newUnit}`;
      }
    }

    fetch('/update_inventory', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: name,
        quantity: newQuantity,
        unit: newUnit
      })
    })
    .then(response => response.json())
    .then(data => {
      checkQuantity(data.data);
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }

  function deleteItem() {
    const name = itemName.textContent;
    deleteDialog.close();

    const itemWrapper = document.querySelector(`.item-wrapper[data-index="${currentItemIndex}"]`);
    if (itemWrapper) {
      itemWrapper.remove();
    }

    fetch('/delete_inventory', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: name
      })
    })
    .then(response => response.json())
    .then(data => {
      checkQuantity(data.data);
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }

  function addNewItem() {
    const newItemName = document.getElementById('newItemName').value;
    const newItemQuantity = document.getElementById('newItemQuantity').value;
    const newItemUnit = document.getElementById('newItemUnit').value;
    addItemDialog.close();

    const newIndex = document.querySelectorAll('.item-wrapper').length + 1;
    const newListItem = `
      <li data-index="${newIndex}" data-name="${newItemName}" data-quantity="${newItemQuantity}" data-unit="${newItemUnit}" class="item-wrapper">
        <p class="transition-colors duration-500">${newItemName}</p>
        <div class="status"><span id="quantity${newIndex}">${newItemQuantity}</span> ${newItemUnit}</div>
        <button class="btn interactable show-dialog">Update</button>
      </li>
    `;
    document.querySelector('.items').insertAdjacentHTML('beforeend', newListItem);

    attachEventListeners();

    fetch('/update_inventory', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        name: newItemName,
        quantity: newItemQuantity,
        unit: newItemUnit
      })
    })
    .then(response => response.json())
    .then(data => {
      checkQuantity(data.data);
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  }

  function attachEventListeners() {
    document.querySelectorAll('.show-dialog').forEach(button => {
      button.addEventListener('click', () => {
        const itemWrapper = button.parentElement;
        currentItemIndex = itemWrapper.getAttribute('data-index');
        itemName.textContent = itemWrapper.getAttribute('data-name');
        inputQuantity.value = itemWrapper.getAttribute('data-quantity');
        inputUnit.value = itemWrapper.getAttribute('data-unit');
        updateDialog.showModal();
        inputQuantity.focus();
      });
    });

    deleteBtn.addEventListener('click', () => {
      deleteDialog.showModal();
    });

    confirmDeleteBtn.addEventListener('click', () => {
      updateDialog.close();
      deleteItem();
    });
  }
</script>
{% endblock %}
