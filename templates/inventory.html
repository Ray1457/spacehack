{% extends "base.html" %}

{% block content %}
    <main>
      <h1 class="font-bold text-3xl mb-12">Inventory</h1>

        <p class="border border-red bg-red-950 text- w-[100%] max-w-[50rem] py-6 flex items-center justify-center font-bold rounded-xl alert  hidden"></p>
      
        <ul class="items">
            {% for item in inventory %}
            <li data-index="{{ loop.index }}" data-name="{{ item[0] }}" data-quantity="{{ item[1] }}" class="item-wrapper">
                <p class="transition-colors duration-500">{{ item[0] }}</p>
                <div class="status"><span id="quantity{{ loop.index }}">{{ item[1] }}</span> {{item[2]}}</div>
                <button class="btn interactable show-dialog" >Update</button>
            </li>
            {% endfor %}
        </ul>

        <!-- Single Reusable Dialog -->
        <dialog id="updateDialog">
            <h1>Update</h1>
            <form id="updateForm">
                <p id="itemName" class="text-[#dadada]"></p>
                <input type="text" placeholder="New Quantity" id="inputQuantity" class="text-[#dadada]">
                <div>
                    <button value="cancel" formmethod="dialog" class="btn-2 interactable">Cancel</button>
                    <button id="confirmBtn" value="default" class="btn-2 interactable">Confirm</button>
                </div>
            </form>
        </dialog>
    </main>

    <script>
                const updateDialog = document.getElementById('updateDialog');
        const inputQuantity = document.getElementById('inputQuantity');
        const confirmBtn = document.getElementById('confirmBtn');
        const itemName = document.getElementById('itemName');
        const updateForm = document.getElementById('updateForm');
        let currentItemIndex = null;

        const threshold = 5;

        document.addEventListener('DOMContentLoaded', () => {
            // Serialize `inventory` data to a JSON string and parse it in JavaScript
            
            const inventoryData = {{ inventory | tojson }};
            checkQuantity(inventoryData);
    
            document.querySelectorAll('.show-dialog').forEach(button => {
                button.addEventListener('click', () => {
                    const itemWrapper = button.parentElement;
                    currentItemIndex = itemWrapper.getAttribute('data-index');
                    itemName.textContent = itemWrapper.getAttribute('data-name');
                    inputQuantity.value = itemWrapper.getAttribute('data-quantity');
                    updateDialog.showModal();
                    inputQuantity.focus(); // Focus on the input field when dialog opens
                });
            });
    
            // Handle form submission
            updateForm.addEventListener('submit', (event) => {
                event.preventDefault();
                confirmUpdate();
            });
        });

        function blink(item) {
            setInterval(() => {
                item.classList.toggle('blink')
            }, 750);
        }
    
        function checkQuantity(param) {
            let jsinventory = param;
            let isAlert = false;
            const alert = document.querySelector('.alert');
            for (const i of jsinventory) {
                if (parseInt(i[1]) < threshold) {        
                    alert.classList.remove('hidden')           
                    alert.textContent = `Only ${i[1]} ${i[2]} of ${i[0]} remaining. Restock it immediately`;
                    isAlert = true;
                    const itemLabel = document.querySelector(`[data-name="${i[0]}"]`).querySelector('p')
                    blink(itemLabel);
                }
            };
            if (!isAlert) {
                alert.classList.add('hidden');
                
            }
        }
    
        function confirmUpdate() {
            const newQuantity = inputQuantity.value;
            const name = itemName.textContent;
            updateDialog.close(newQuantity);
    
            // Update the quantity display in the list
            if (currentItemIndex) {
                document.getElementById(`quantity${currentItemIndex}`).textContent = newQuantity;
    
                const button = document.querySelector(`.item-wrapper[data-index="${currentItemIndex}"]`);
                if (button) {
                    button.setAttribute('data-quantity', newQuantity);
                }
            }
    
            // Send the update to the backend
            fetch('/update_inventory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    quantity: newQuantity
                })
            })
            .then(response => response.json())
            .then(data => {
                checkQuantity(data.data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    </script>
    
{% endblock %}
